#!/bin/bash

restoreFile="$HOME/.restore.info"
recycleBin="$HOME/recyclebin"

createRestoreFileIfNotExist() {
	if [ ! -e "$restoreFile" ]; then
		touch "$restoreFile"
	fi
}

validateArgs() {
	if [ "$#" -le 0 ]; then
		echo "$0: no filename is provided"
		exit 1
	fi
}

validateFile() {
	if [ ! -e "$1" ]; then
		echo "$0: file '$1' does not exist"
		exit 2
	fi

	if [ -d "$1" ]; then
		echo "$0: '$1' is a directory, but expect a file"
		exit 3
	fi

	if [ "$(realpath "$1")" == "$(readlink -f "$0")" ]; then
		echo "$0: cannot recycle itself"
		exit 4
	fi
}

getRecycleFileName() {
	inodeNumber="$(ls -i "$1" | cut -d' ' -f1)"
	basefilename="$(basename "$1")"
	echo "${basefilename}_${inodeNumber}"
	unset inodeNumber
}

# 1st arg: recycle file name
# 2nd arg: absolute path
writeRecord() {
	record="$1:$2"

	if grep -Fqe "$record" "$restoreFile"; then
		echo "$0: record '$record' already exists in '$restoreFile', you can't recycle same filename with same inode number"
		exit 5
	else
		echo "$record" >>"$restoreFile"
	fi
}

recycleFile() {
	validateFile "$1"

	absPath="$(realpath "$1")"
	recycleFileName="$(getRecycleFileName "$1")"

	mv "$1" "$recycleBin/$recycleFileName"
	writeRecord "$recycleFileName:$absPath"
}

########
# main #
########

validateArgs "$@"
createRestoreFileIfNotExist
mkdir -p "$recycleBin"

for file in "$@"; do
	recycleFile "$file"
done
